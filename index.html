<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HWC33 – WG-Finanzen</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

  <style>
    :root{--bg:#0f1115;--card:#171a21;--muted:#a9b0bd;--text:#e9ecf2;--accent:#6ea8fe;--good:#20c997;--bad:#ff5c5c;--line:#252a35;}
    body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1000px;margin:0 auto;padding:18px;display:grid;gap:14px;}
    .cardish{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .title{display:flex;align-items:center;gap:10px;margin:2px 0 14px 0;flex-wrap:wrap;}
    .title h1{font-size:18px;margin:0;}
    .pill{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    @media (max-width:900px){.grid2{grid-template-columns:1fr;}}
    .sectionhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:10px;flex-wrap:wrap;}
    .sectionhead h2{font-size:14px;margin:0;color:var(--accent);letter-spacing:.02em;text-transform:uppercase;}
    .badgeish{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:rgba(255,255,255,.03);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted);}
    .rowgap{display:grid;gap:10px;}
    .person{display:flex;align-items:center;justify-content:space-between;border-radius:14px;padding:12px 12px;border:1px solid var(--line);}
    .person.paid{background:linear-gradient(90deg, rgba(32,201,151,.15), rgba(32,201,151,.03));}
    .person.unpaid{background:linear-gradient(90deg, rgba(255,92,92,.15), rgba(255,92,92,.03));}
    .name{display:flex;align-items:center;gap:10px;font-weight:700;}
    .dot{width:10px;height:10px;border-radius:99px;}
    .dot.good{background:var(--good);}
    .dot.bad{background:var(--bad);}
    .big{font-size:28px;font-weight:800;}
    .subbig{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4;}
    table{width:100%;}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.03em;color:#dfe6ff;background:rgba(110,168,254,.14);border-bottom:1px solid var(--line);padding:10px;}
    tbody td{padding:10px;border-bottom:1px solid var(--line);color:var(--text);}
    .tcenter{text-align:center;}
    .tright{text-align:right;}
    .in{color:var(--good);font-weight:800;}
    .out{color:var(--bad);font-weight:800;}
    .muted{color:var(--muted);}
    .links a{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.03);text-decoration:none;margin-right:6px;}
    .links a:hover{border-color:rgba(110,168,254,.55);}
    .notice{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:16px;padding:12px;color:var(--text);}
    .err{border:1px solid rgba(255,92,92,.4);background:rgba(255,92,92,.08);border-radius:16px;padding:12px;color:#ffd5d5;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="cardish">
      <div class="title">
        <i class="bi bi-wallet2" style="color:var(--accent);font-size:18px;"></i>
        <h1>HWC33 – WG-Finanzen</h1>
        <span id="meta" class="pill">lädt…</span>
      </div>
      <div class="notice">
        Da ist die WG-Finanzwebsite von HWC33. Oben siehst du, wer bezahlt hat. Unten siehst du den aktuellen Kontostand und die komplette Historie inkl. Belegen.
      </div>
      <div class="mt-2">
        <span class="badgeish" id="fxPill"><i class="bi bi-currency-exchange"></i> EUR→CHF: –</span>
      </div>
    </div>

    <div class="grid2">
      <div class="cardish">
        <div class="sectionhead">
          <h2><i class="bi bi-people"></i> Bezahlstatus</h2>
          <span id="duePill" class="badgeish">offen: –</span>
        </div>
        <div id="paymentsList" class="rowgap"></div>
      </div>

      <div class="cardish">
        <div class="sectionhead">
          <h2><i class="bi bi-piggy-bank"></i> Konto (CHF)</h2>
          <span id="balancePill" class="badgeish">–</span>
        </div>
        <div class="big" id="balanceCHF">CHF –</div>
        <div class="subbig">
        </div>
      </div>
    </div>

    <div class="cardish">
      <div class="sectionhead">
        <h2><i class="bi bi-clock-history"></i> Historie</h2>
        <span class="badgeish"><i class="bi bi-paperclip"></i> /receipts</span>
      </div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th class="tcenter">Typ</th>
              <th class="tright">Original</th>
              <th class="tright">Δ CHF</th>
              <th class="tcenter">Belege</th>
              <th class="tright">Saldo CHF</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <div id="errorBox" class="err" style="display:none;"></div>
  </div>

  <script>
    const safe = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    const fmtCHF = (n) => new Intl.NumberFormat("de-CH",{style:"currency",currency:"CHF",minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(n||0));
    const fmtEUR = (n) => new Intl.NumberFormat("de-CH",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(n||0));

    const parseDate = (d) => {
      const t = Date.parse(String(d ?? ""));
      return Number.isFinite(t) ? t : 0;
    };

    const hasVal = (v) => v !== undefined && v !== null && v !== "";

    const toChf = (h, fxGlobal) => {
      if (hasVal(h?.amount_chf)) return Number(h.amount_chf) || 0;
      if (hasVal(h?.amount_eur)) {
        const fx = Number(h?.fx_eur_chf ?? fxGlobal) || 0;
        return (Number(h.amount_eur) || 0) * fx;
      }
      return 0;
    };

    const originalLabel = (h) => {
      const hasCHF = hasVal(h?.amount_chf);
      const hasEUR = hasVal(h?.amount_eur);
      if (hasCHF && hasEUR) return safe(fmtCHF(h.amount_chf) + " + " + fmtEUR(h.amount_eur));
      if (hasCHF) return safe(fmtCHF(h.amount_chf));
      if (hasEUR) return safe(fmtEUR(h.amount_eur));
      return `<span class="muted">–</span>`;
    };

    async function main(){
      try{
        const res = await fetch("./data.yml", { cache:"no-store" });
        if(!res.ok) throw new Error("data.yml nicht gefunden (Status " + res.status + ")");
        const text = await res.text();
        const data = jsyaml.load(text);

        const payments = Array.isArray(data?.payments) ? data.payments : [];
        const history  = Array.isArray(data?.history) ? data.history : [];

        const fxGlobal = Number(data?.fx?.eur_chf ?? 0.95) || 0.95;

        document.getElementById("fxPill").innerHTML = `<i class="bi bi-currency-exchange"></i> EUR→CHF: ${safe(fxGlobal.toFixed(4))}`;
        document.getElementById("meta").textContent = "Stand: " + new Date().toLocaleString("de-CH");

        const due = payments.reduce((acc,p)=>acc + (!!p.paid ? 0 : Number(p.amount_chf ?? p.amount ?? 0)), 0);
        document.getElementById("duePill").textContent = "offen: " + fmtCHF(due);

        const list = document.getElementById("paymentsList");
        list.innerHTML = payments.map(p => {
          const paid = !!p.paid;
          const chf = Number(p.amount_chf ?? p.amount ?? 0);
          return `
            <div class="person ${paid ? "paid":"unpaid"}">
              <div class="name">
                <span class="dot ${paid ? "good":"bad"}"></span>
                <span>${safe(p.name)}</span>
              </div>
              <div>${safe(fmtCHF(chf))}</div>
            </div>
          `;
        }).join("");

        const sorted = [...history].sort((a,b)=>parseDate(a.date)-parseDate(b.date));

        let running = 0;
        const rows = sorted.map(h => {
          const sign = (h.type === "in") ? 1 : -1;
          const chf = toChf(h, fxGlobal);
          const delta = sign * chf;
          running += delta;

          const typeLabel = (h.type === "in") ? `<span class="in">IN</span>` : `<span class="out">OUT</span>`;
          const deltaCell = `<span class="${h.type === "in" ? "in":"out"}">${safe(fmtCHF(delta))}</span>`;

          const recs = Array.isArray(h.receipts) ? h.receipts : [];
          let links = "–";
          if (recs.length){
            links = `<span class="links">${
              recs.map(r => `<a href="receipts/${encodeURIComponent(r)}" target="_blank" rel="noopener"><i class="bi bi-file-earmark-pdf"></i></a>`).join("")
            }</span>`;
          }

          return `
            <tr>
              <td>${safe(h.date)}</td>
              <td class="tcenter">${typeLabel}</td>
              <td class="tright">${originalLabel(h)}</td>
              <td class="tright">${deltaCell}</td>
              <td class="tcenter">${links}</td>
              <td class="tright">${safe(fmtCHF(running))}</td>
            </tr>
          `;
        }).join("");

        document.getElementById("historyBody").innerHTML = rows || `<tr><td colspan="6" class="muted">Keine Einträge</td></tr>`;
        document.getElementById("balanceCHF").textContent = fmtCHF(running);
        document.getElementById("balancePill").textContent = fmtCHF(running);
      } catch(e){
        const box = document.getElementById("errorBox");
        box.style.display = "block";
        box.textContent = "Fehler: " + (e?.message || String(e));
      }
    }

    main();
  </script>
</body>
</html>
